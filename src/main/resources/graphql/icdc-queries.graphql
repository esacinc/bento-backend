schema {
 query: QueryType
}

type BreedCaseCount {
  breed: String
  cases: Int
}

type CaseDetail {
  patient_id: String
  breed: String
  patient_age_at_enrollment: Float
  sex: String
  disease_term: String
  stage_of_disease: String
}

type StudyCodeCaseCount {
  study_code: String
  cases: Int
}

type DiagnosisCaseCount {
  diagnosis: String
  cases: Int
}

type GenderCaseCount {
  gender: String
  cases: Int
}


type DiseaseSiteCaseCount {
  disease_site: String
  cases: Int
}

type NeuteredStatusCaseCount {
  neutered_status: String
  cases: Int
}

type StageOfDiseaseCaseCount {
  stage_of_disease :String
  cases :Int
}

type StudyTypeCaseCount {
  study_type: String
  cases: Int
}

type AgeCaseCount {
  age: Float
  cases: Int
}

type FileTypeCaseCount {
  data_type: String
  cases: Int
}

type ProgramCaseCount {
  program: String
  cases: Int
}

type FileFormatCaseCount {
  file_format: String
  cases: Int
}

type StudyOfProgram {
  program_id: String
  clinical_study_id: String
  clinical_study_designation: String
  clinical_study_name: String
  clinical_study_description: String
  clinical_study_type: String
  date_of_iacuc_approval: String
  dates_of_conduct: String
  numberOfCases: Int
  case_ids: [String]
}

type CaseOverview {
  case_id: String
  program: String
  study_code: String
  study_type: String
  breed: String
  diagnosis: String
  stage_of_disease: String
  age: Float
  sex: String
  neutered_status: String
  data_types: [String]
  disease_site: String
  samples: [String]
  files: [file]
  file_formats: [String]
}


type FilesOfCase{
  case_id: String
  parent:String
  file_name: String
  file_type: String
  file_description: String
  file_format: String
  file_size: Float
  md5sum: String
  file_status: String
  uuid: String
  file_locations: String
}


type FileFormatCaseCount {
  file_format: String
  cases: Int
}



type QueryType {
  "Version"
  schemaVersion: String @cypher(statement: "RETURN '0.1.0'")

  "Simple count"
  numberOfStudies: Int @cypher(statement: "MATCH (n:study) RETURN  count (n)")
  numberOfCases: Int @cypher(statement: "MATCH (n:case) RETURN  count (n)")
  numberOfSamples:Int @cypher(statement: "MATCH (n:sample) RETURN  count (n)")
  numberOfFiles: Int @cypher(statement: "MATCH (n:file) RETURN  count (n)")
  numberOfAliquots: Int @cypher(statement: "MATCH (n:aliquot) return count(n)")

  "Count with parameter"
  sampleCountOfStudy(study_code: String!): Int @cypher(statement: "MATCH (s:sample)-[*]->(:study {clinical_study_designation: $study_code}) return count(DISTINCT(s))")
  fileCountOfStudy(study_code: String!): Int @cypher(statement: "MATCH (f:file)-[*]->(:study {clinical_study_designation: $study_code}) return count(distinct(f))")
  aliguotCountOfStudy(study_code: String!): Int @cypher(statement: "MATCH (a:aliquot)-[*]->(:study {clinical_study_designation: $study_code}) return count(DISTINCT(a))")
  caseCountOfStudy(study_code: String!): Int @cypher(statement: "MATCH (c:case)-[*]->(:study {clinical_study_designation: $study_code}) return count(distinct(c))")
  fileCountOfCase(case_id: String!): Int @cypher(statement: "MATCH (f:file)-[*]->(c:case {case_id: $case_id}) return count(DISTINCT(f))")
  aliquotCountOfCase(case_id: String!): Int @cypher(statement: "MATCH (a:aliquot)-[*]->(c:case {case_id: $case_id}) return count(DISTINCT(a))")
  sampleCountOfProgram(program_id: String!): Int @cypher(statement: "MATCH (s:sample)-[*]->(:program {program_acronym: $program_id}) return count(DISTINCT(s))")
  fileCountOfProgram(program_id: String!): Int @cypher(statement: "MATCH (f:file)-[*]->(:program {program_acronym: $program_id}) return count(DISTINCT(f))")
  aliguotCountOfProgram(program_id: String!): Int @cypher(statement: "MATCH (a:aliquot)-[*]->(:program {program_acronym: $program_id}) return count(DISTINCT(a))")
  studyCountOfProgram(program_id: String!): Int @cypher(statement: "MATCH (s:study)-[*]->(:program {program_acronym: $program_id}) return count(DISTINCT(s))")
  caseCountOfProgram(program_id: String!): Int @cypher(statement: "MATCH (c:case)-[*]->(:program {program_acronym: $program_id}) return count(DISTINCT(c))")
  sampleCountOfCase(case_id: String!): Int @cypher(statement: "MATCH (c:case {case_id: $case_id})<-[*]-(s:sample) RETURN count(distinct(s))")

  "Count by group"
  caseCountByStudyCode(case_ids: [String] = []): [StudyCodeCaseCount] @cypher(statement: """
    MATCH (s:study)<-[:member_of]-(c:case)
    WHERE (size($case_ids) = 0 OR c.case_id IN $case_ids)
    RETURN
      s.clinical_study_designation AS study_code,
      count(DISTINCT(c)) AS cases
    ORDER BY
      s.clinical_study_designation
  """)

  caseCountByDiagnosis(case_ids: [String] = []): [DiagnosisCaseCount] @cypher(statement: """
    MATCH (d:diagnosis)-[:of_case]->(c:case)
      WHERE (size($case_ids) = 0 OR c.case_id IN $case_ids)
    RETURN
      d.disease_term AS diagnosis,
      count(c) AS cases
    ORDER BY
      d.disease_term
  """)

  caseCountByGender(case_ids: [String] = []): [GenderCaseCount] @cypher(statement: """
    MATCH (d:demographic)-[:of_case]->(c:case)
    WHERE (size($case_ids) = 0 OR c.case_id IN $case_ids)
    RETURN
      d.sex AS gender,
      count(c) AS cases
    ORDER BY
      d.sex
  """)

  caseCountByBreed(case_ids: [String] = []): [BreedCaseCount] @cypher(statement: """
    MATCH (c:case)<-[:of_case]-(d:demographic)
    WHERE (size($case_ids) = 0 OR c.case_id IN $case_ids)
    RETURN
      d.breed AS breed,
      count(c) AS cases
  """)

  caseCountByNeuteredStatus(case_ids: [String] = []): [NeuteredStatusCaseCount] @cypher(statement: """
    MATCH (c:case)<-[:of_case]-(d:demographic)
    WHERE (size($case_ids) = 0 OR c.case_id IN $case_ids)
    RETURN
      d.neutered_indicator AS neutered_status,
      count(c) AS cases
  """)

  caseCountByStageOfDisease(case_ids: [String] = []): [StageOfDiseaseCaseCount] @cypher(statement: """
    MATCH (d:diagnosis)-[:of_case]->(c:case)
    WHERE (size($case_ids) = 0 OR c.case_id IN $case_ids)
    RETURN
      d.stage_of_disease AS stage_of_disease,
      count(c) AS cases
    ORDER BY
      d.stage_of_disease
  """)

  caseCountByDiseaseSite(case_ids: [String] = []): [DiseaseSiteCaseCount] @cypher(statement: """
    MATCH (d:diagnosis)-[:of_case]->(c:case)
    WHERE (size($case_ids) = 0 OR c.case_id IN $case_ids)
    RETURN
      d.primary_disease_site AS disease_site,
      count(c) AS cases
    ORDER BY
      d.primary_disease_site
  """)

  caseCountByStudyType(case_ids: [String] = []): [StudyTypeCaseCount] @cypher(statement: """
    MATCH (s:study)<-[:member_of]-(c:case)
    WHERE (size($case_ids) = 0 OR c.case_id IN $case_ids)
    RETURN
      s.clinical_study_type AS study_type,
      COUNT(DISTINCT(c)) AS cases
  """)

  caseCountByAge(case_ids: [String] = []): [AgeCaseCount] @cypher(statement: """
    MATCH (d:demographic)-[:of_case]->(c:case)
    WHERE (size($case_ids) = 0 OR c.case_id IN $case_ids)
    RETURN
      d.patient_age_at_enrollment AS age,
      COUNT(DISTINCT(c)) AS cases ORDER BY age
  """)

  caseCountByDataType(case_ids: [String] = []): [FileTypeCaseCount] @cypher(statement: """
    MATCH (f:file)-[*]->(c:case)
    WHERE (size($case_ids) = 0 OR c.case_id IN $case_ids)
    RETURN
      f.file_type AS data_type,
      COUNT(DISTINCT(c)) AS cases
    ORDER BY
      data_type
  """)

  caseCountByFileFormat(case_ids: [String] = []): [FileFormatCaseCount] @cypher(statement: """
    MATCH (f:file)-[*]->(c:case)
    WHERE (size($case_ids) = 0 OR c.case_id IN $case_ids)
    RETURN
      f.file_format AS file_format,
      COUNT(DISTINCT(c)) AS cases
    ORDER BY
      file_format
  """)

  caseCountByProgram(case_ids: [String] = []): [ProgramCaseCount] @cypher(statement: """
    Match (p:program)<-[:member_of]-(s)<-[:member_of]-(c:case)
    WHERE (size($case_ids) = 0 OR c.case_id IN $case_ids)
    RETURN
      p.program_acronym AS program,
      COUNT(DISTINCT(c)) AS cases
    ORDER BY
      program
  """)

  "Combined info"
  studiesByProgramId(program_id: String!): [StudyOfProgram] @cypher(statement: "MATCH (p:program {program_acronym: $program_id})<-[*]-(s:study) OPTIONAL MATCH (s)<-[*]-(c:case) RETURN p.program_acronym AS program_id, s.clinical_study_id AS clinical_study_id, s.clinical_study_designation AS clinical_study_designation, s.clinical_study_name AS clinical_study_name, s.clinical_study_description AS clinical_study_description, s.clinical_study_type AS clinical_study_type, s.date_of_iacuc_approval AS date_of_iacuc_approval, s.dates_of_conduct AS dates_of_conduct, COUNT(DISTINCT(c)) as numberOfCases ORDER BY clinical_study_designation")
  studiesByProgram: [StudyOfProgram] @cypher(statement:"MATCH (s:study) OPTIONAL MATCH (p:program)<-[*]-(s) OPTIONAL MATCH (s)<-[*]-(c:case) RETURN p.program_acronym AS program_id, s.clinical_study_id AS clinical_study_id, s.clinical_study_designation AS clinical_study_designation, s.clinical_study_name AS clinical_study_name, s.clinical_study_description AS clinical_study_description, s.clinical_study_type AS clinical_study_type, s.date_of_iacuc_approval AS date_of_iacuc_approval, s.dates_of_conduct AS dates_of_conduct, COUNT(DISTINCT(c)) as numberOfCases ORDER BY clinical_study_designation")
  filesOfCase(case_id: String!): [FilesOfCase] @cypher(statement: "MATCH (f:file)-[*]->(c:case{case_id: $case_id}) WITH DISTINCT(f) AS f MATCH (f)-->(parent) RETURN f.file_status AS file_status,f.file_name AS file_name ,f.file_type AS file_type,f.file_description AS file_description,f.file_format AS file_format,f.file_size AS file_size,f.md5sum AS md5sum,f.uuid AS uuid,f.file_locations AS file_locations, head(labels(parent)) AS parent, $case_id AS case_id")
  filesOfCases(case_ids: [String!]!): [FilesOfCase] @cypher(statement: "MATCH (f:file)-[*]->(c:case) WITH DISTINCT(f) AS f, c MATCH (f)-->(parent) WHERE c.case_id IN $case_ids RETURN f.file_status AS file_status,f.file_name AS file_name ,f.file_type AS file_type,f.file_description AS file_description,f.file_format AS file_format,f.file_size AS file_size,f.md5sum AS md5sum,f.uuid AS uuid,f.file_locations AS file_locations, head(labels(parent)) AS parent, c.case_id AS case_id")
  caseOverview(study_codes: [String] = [], breeds: [String] = [], diagnoses: [String] = [], sexes: [String] = []): [CaseOverview] @cypher(statement: "MATCH (s:study) WITH COLLECT(DISTINCT(s.clinical_study_designation)) AS all_studies MATCH (d:demographic) WITH COLLECT(DISTINCT(d.breed)) AS all_breeds, COLLECT(DISTINCT(d.sex)) AS all_sexes, all_studies MATCH (d:diagnosis) WITH COLLECT(DISTINCT(d.disease_term)) AS all_diseases, all_breeds, all_sexes, all_studies MATCH (p:program)<-[*]-(s:study)<-[*]-(c:case)<--(demo:demographic), (c)<--(diag:diagnosis) WHERE s.clinical_study_designation IN CASE $study_codes WHEN [] THEN all_studies ELSE $study_codes END AND demo.breed IN CASE $breeds WHEN [] THEN all_breeds ELSE $breeds END AND diag.disease_term IN CASE $diagnoses WHEN [] THEN all_diseases ELSE $diagnoses END AND demo.sex IN CASE $sexes WHEN [] THEN all_sexes ELSE $sexes END OPTIONAL MATCH (f:file)-[*]->(c), (samp:sample)-[*]->(c) WITH DISTINCT c AS c, p, s, demo, diag, f, samp RETURN c.case_id AS case_id, s.clinical_study_designation AS study_code, p.program_acronym AS program, s.clinical_study_type AS study_type, demo.breed AS breed, diag.disease_term AS diagnosis, diag.stage_of_disease AS stage_of_disease, diag.primary_disease_site AS disease_site,demo.patient_age_at_enrollment AS age, demo.sex AS sex, demo.neutered_indicator AS neutered_status, COLLECT(DISTINCT(f.file_type)) AS data_types, COLLECT(DISTINCT(f.file_format)) AS file_formats, COLLECT(DISTINCT(f)) AS files,  COLLECT(DISTINCT(samp.sample_id)) as samples", passThrough:true)
  casesInList(case_ids: [String!]!): [CaseOverview] @cypher(statement: "MATCH (p:program)<-[*]-(s:study)<-[*]-(c:case)<--(demo:demographic), (c)<--(diag:diagnosis) WHERE c.case_id IN $case_ids OPTIONAL MATCH (f:file)-[*]->(c), (samp:sample)-[*]->(c) WITH DISTINCT c AS c, p, s, demo, diag, f, samp RETURN c.case_id AS case_id, s.clinical_study_designation AS study_code, p.program_acronym AS program, s.clinical_study_type AS study_type, demo.breed AS breed, diag.disease_term AS diagnosis, diag.stage_of_disease AS stage_of_disease, diag.primary_disease_site AS disease_site,demo.patient_age_at_enrollment AS age, demo.sex AS sex, demo.neutered_indicator AS neutered_status, COLLECT(DISTINCT(f.file_type)) AS data_types, COLLECT(DISTINCT(f.file_format)) AS file_formats, COLLECT(DISTINCT(f.uuid)) AS files,  COLLECT(DISTINCT(samp.sample_id)) as samples")

  "Find nodes with parameters"
  casesByStudyId(study_id: String!): [case] @cypher(statement: "MATCH (s:study {clinical_study_designation: $study_id})<-[*]-(c:case) return DISTINCT(c)")
  samplesByCaseId(case_id: String!): [sample] @cypher(statement: "MATCH (c:case {case_id: $case_id})<-[*]-(s:sample) RETURN s")
  filesBySampleId(sample_id: String!): [file] @cypher(statement: "MATCH (s:sample {sample_id: $sample_id})<-[*]-(f:file) RETURN f")
  filesOfStudy(study_code: String!): [file] @cypher(statement: "MATCH (f:file)-[*]->(:study {clinical_study_designation: $study_code}) return DISTINCT(f)")
}